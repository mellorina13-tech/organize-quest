// Add these functions to your organizations.html script section

// Check if user has joined an organization
async function hasUserJoinedOrg(orgId) {
    if (!currentUser) return false;
    
    try {
        const { data, error } = await supabase
            .from('memberships')
            .select('id')
            .eq('organization_id', orgId)
            .eq('user_id', currentUser.id)
            .single();
        
        return !error && data;
    } catch (err) {
        return false;
    }
}

// Get membership count for organization
async function getMembershipCount(orgId) {
    try {
        const { count, error } = await supabase
            .from('memberships')
            .select('*', { count: 'exact', head: true })
            .eq('organization_id', orgId);
        
        return error ? 0 : count;
    } catch (err) {
        return 0;
    }
}

// Join organization
async function joinOrganization(orgId) {
    if (!currentUser) {
        alert('Please log in to join organizations!');
        window.location.href = 'profile.html';
        return;
    }

    const org = organizations.find(o => o.id === orgId);
    if (!org) return;

    // Check if organization is full
    if (org.max_attendees) {
        const currentCount = await getMembershipCount(orgId);
        if (currentCount >= org.max_attendees) {
            alert('This organization is full!');
            return;
        }
    }

    try {
        const { error } = await supabase
            .from('memberships')
            .insert([{
                organization_id: orgId,
                user_id: currentUser.id
            }]);

        if (error) {
            if (error.code === '23505') { // Unique violation
                alert('You have already joined this organization!');
            } else {
                alert('Error joining organization: ' + error.message);
            }
            return;
        }

        alert('Successfully joined organization!');
        await loadOrganizations();
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// Leave organization
async function leaveOrganization(orgId) {
    if (!currentUser) {
        alert('Please log in first!');
        return;
    }

    if (!confirm('Are you sure you want to leave this organization?')) {
        return;
    }

    try {
        const { error } = await supabase
            .from('memberships')
            .delete()
            .eq('organization_id', orgId)
            .eq('user_id', currentUser.id);

        if (error) {
            alert('Error leaving organization: ' + error.message);
            return;
        }

        alert('Successfully left organization!');
        await loadOrganizations();
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// Updated loadOrganizations function
async function loadOrganizations() {
    try {
        const { data, error } = await supabase
            .from('organizations')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error loading organizations:', error);
            return;
        }

        organizations = data || [];
        
        // Load membership status for each organization
        if (currentUser) {
            for (let org of organizations) {
                org.userIsMember = await hasUserJoinedOrg(org.id);
                org.current_attendees = await getMembershipCount(org.id);
            }
        }

        // Clear existing markers
        map.eachLayer(function(layer) {
            if (layer instanceof L.Marker && layer !== userMarker) {
                map.removeLayer(layer);
            }
        });

        // Add markers for all organizations
        organizations.forEach(org => {
            addOrganizationMarker(org);
        });

        updateOrganizationList();
        updateStats();
    } catch (err) {
        console.error('Error:', err);
    }
}

// Updated addOrganizationMarker function
function addOrganizationMarker(org) {
    const categoryIcons = {
        'Education': 'üéì', 'Healthcare': 'üè•', 'Technology': 'üíª',
        'Non-Profit': 'ÔøΩ', 'Sports': '‚öΩ', 'Arts': 'üé®',
        'Environment': 'üå±', 'Community': 'üèôÔ∏è'
    };
    const icon = categoryIcons[org.category] || 'üìå';

    let popupContent = `
        <div style="min-width: 250px;">
            <h3 style="color: var(--primary); margin-bottom: 10px;">${icon} ${org.name}</h3>
            <p><strong>Category:</strong> ${org.category}</p>
            ${org.description ? `<p>${org.description}</p>` : ''}
    `;

    // Show attendee info if quota is set
    if (org.max_attendees) {
        const currentCount = org.current_attendees || 0;
        const isFull = currentCount >= org.max_attendees;
        const spotsLeft = org.max_attendees - currentCount;
        
        popupContent += `
            <div style="margin-top: 10px; padding: 10px; background: ${isFull ? '#ffebee' : '#e8f5e9'}; border-radius: 5px;">
                <strong>üë• Attendees:</strong> ${currentCount}/${org.max_attendees}
                ${isFull ? 
                    '<br><span style="color: #c62828;">‚ö†Ô∏è Full</span>' : 
                    `<br><span style="color: #2e7d32;">‚úì ${spotsLeft} spots available</span>`
                }
            </div>
        `;
    }

    if (org.contactEmail) {
        popupContent += `<p><strong>üìß Email:</strong> ${org.contactEmail}</p>`;
    }

    // Add join/leave button
    if (currentUser) {
        const isFull = org.max_attendees && (org.current_attendees || 0) >= org.max_attendees;
        const isMember = org.userIsMember;
        
        if (isMember) {
            popupContent += `
                <button onclick="leaveOrganization('${org.id}')" 
                        style="width: 100%; margin-top: 10px; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                    Leave Organization
                </button>
            `;
        } else if (!isFull) {
            popupContent += `
                <button onclick="joinOrganization('${org.id}')" 
                        style="width: 100%; margin-top: 10px; padding: 8px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                    Join Organization
                </button>
            `;
        } else {
            popupContent += `
                <button disabled
                        style="width: 100%; margin-top: 10px; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: not-allowed; font-weight: 600;">
                    Organization Full
                </button>
            `;
        }
    }

    popupContent += `</div>`;

    const marker = L.marker([org.latitude, org.longitude])
        .addTo(map)
        .bindPopup(popupContent);
}

// Updated organization list rendering
function updateOrganizationList() {
    const listContainer = document.getElementById('orgList');
    
    if (organizations.length === 0) {
        listContainer.innerHTML = '<p style="text-align: center; color: #999;">No organizations yet. Create the first one!</p>';
        return;
    }

    listContainer.innerHTML = organizations.map(org => {
        const categoryIcons = {
            'Education': 'üéì', 'Healthcare': 'üè•', 'Technology': 'üíª',
            'Non-Profit': 'ÔøΩ', 'Sports': '‚öΩ', 'Arts': 'üé®',
            'Environment': 'üå±', 'Community': 'üèôÔ∏è'
        };
        const icon = categoryIcons[org.category] || 'üìå';
        const isMember = org.userIsMember;
        const isFull = org.max_attendees && (org.current_attendees || 0) >= org.max_attendees;

        let cardHTML = `
            <div class="org-card" onclick="focusOrganization('${org.id}')">
                <h3>${icon} ${org.name} ${isMember ? '<span class="joined-badge">‚úì Member</span>' : ''}</h3>
                <span class="category">${org.category}</span>
        `;

        if (org.max_attendees) {
            cardHTML += `
                <div style="margin-top: 10px; padding: 8px; background: ${isFull ? '#ffebee' : '#e8f5e9'}; border-radius: 8px;">
                    <div style="font-size: 0.9rem; color: ${isFull ? '#c62828' : '#2e7d32'}; font-weight: 600;">
                        üë• ${org.current_attendees || 0}/${org.max_attendees} members
                        ${isFull ? ' (FULL)' : ''}
                    </div>
                </div>
            `;
        }

        if (currentUser) {
            if (isMember) {
                cardHTML += `
                    <button class="btn btn-leave" 
                            onclick="event.stopPropagation(); leaveOrganization('${org.id}')"
                            style="margin-top: 10px; width: 100%;">
                        Leave Organization
                    </button>
                `;
            } else if (!isFull) {
                cardHTML += `
                    <button class="btn btn-join" 
                            onclick="event.stopPropagation(); joinOrganization('${org.id}')"
                            style="margin-top: 10px; width: 100%;">
                        Join Organization
                    </button>
                `;
            }
        }

        cardHTML += '</div>';
        return cardHTML;
    }).join('');
}

// Update the form submission to include max_attendees
document.getElementById('createOrgForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!selectedLocation) {
        alert('Please select a location on the map!');
        return;
    }

    if (!currentUser) {
        alert('Please log in to create an organization!');
        window.location.href = 'profile.html';
        return;
    }

    const orgData = {
        name: document.getElementById('orgName').value,
        category: document.getElementById('orgCategory').value,
        type: document.getElementById('orgType').value,
        description: document.getElementById('orgDescription').value,
        max_attendees: parseInt(document.getElementById('maxParticipants').value) || null, // Add this
        contactEmail: document.getElementById('contactEmail').value,
        contactPhone: document.getElementById('contactPhone').value,
        website: document.getElementById('orgWebsite').value,
        address: document.getElementById('orgAddress').value,
        latitude: selectedLocation.lat,
        longitude: selectedLocation.lng,
        created_by: currentUser.id
    };

    try {
        const { data, error } = await supabase
            .from('organizations')
            .insert([orgData])
            .select();

        if (error) {
            alert('Error: ' + error.message);
            return;
        }

        alert('Organization created successfully!');
        
        this.reset();
        document.getElementById('createModal').classList.remove('show');
        createMode = false;
        selectedLocation = null;
        
        if (window.tempMarker) {
            map.removeLayer(window.tempMarker);
            window.tempMarker = null;
        }

        await loadOrganizations();
    } catch (err) {
        alert('Error creating organization: ' + err.message);
    }
});
